## Integrate Electric into your Flutter app

First we'd recommend you to run the `todos_example` app in the repository.
It contains a working example of Electric in a Flutter app, with Postgres migrations and the Electric service and a Postgres database running on your local machine via Docker.

In order to integrate Electric in your app you can do the following:

### 1. Add the dependency

Add the required dependencies into your project.

```yaml
dependencies:
  electricsql: <version>
  drift: ^2.13.0 # or greater

  # Optionally include if you want to use the Flutter utilities
  electricsql_flutter: <version>

dev_dependencies:
  electricsql_cli: <version>
  drift_dev: ^2.13.0 # or greater
  build_runner: ... # to build the drift code
```

You alternatively can install `electricsql_flutter` instead, which includes a few utilities which are Flutter specific.

Add the `electricsql_cli` dependency as a dev dependency. This tool can be used to automatically generate a [drift](https://pub.dev/packages/drift) schema based on your Postgres schema.


### 2. Configure the backend locally

Take the `backend` folder from the `todos_example` app and copy it into your project.
You can configure the `.envrc` file to change the name of the database, the Electric port, etc...

This folder contains a few scripts to manage the Electric service and the Postgres database.

1. `start.sh`: Starts the Electric service and the Postgres database.
2. `remove.sh`: Stops the service and removes all the Electric and Postgres data, in case you want to start from scratch.
3. `apply-migrations.sh`: Applies the migrations into Postgres. This script uses `dbmate` to manage the migrations. You can use any other tool you want.

### 3. Generate the glue code

`electricsql` for Dart uses [drift](https://pub.dev/packages/drift) to provide a type-safe interface to the local SQLite database.
The `electricsql_cli` tool can be used to automatically generate the `drift` schema based on your Postgres schema. That way you don't need to replicate the Postgres tables in `drift` table definitions in the app.

You can run the tool within your Flutter app as follows:

```sh
dart run electricsql_cli generate
```

After it finishes you should have the folder `lib/generated/electric` created. Inside you will find the `drift` schema and the Electric SQL migrations.

After this point, the app should be configured like a regular app that uses `drift`, with minor adjustments.
You can refer to the official `drift` docs here https://drift.simonbinder.eu/docs/getting-started/

When defining the `drift` database class you need to provide the tables from the generated file.

After defining the database, generate the `drift` code as usual.

```sh
dart run build_runner build
```

#### Sample code:

```dart
import 'dart:io';

import 'package:drift/native.dart';

// Import the generated Drift schema, which contains your electrified tables
import 'package:myapp/generated/electric/drift_schema.dart';

// [IMPORTANT] Add this line to enable the import of electric types for Drift
// You can also import them from `electricsql_flutter`
import 'package:electricsql/drivers/drift.dart'; 

import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart' as p;

// [IMPORTANT LINE!!!] kElectrifiedTables comes from the generated file
// The rest is regular drift code
@DriftDatabase(tables: kElectrifiedTables)
class AppDatabase extends _$AppDatabase {
  AppDatabase() : super(_openConnection());

  @override
  int get schemaVersion => 1;

  // [IMPORTANT CHANGE!!!]
  // Drift by default creates the local database tables. This is done by electric in
  // this situation, so we provide an empty onCreate callback
  @override
  MigrationStrategy get migration {
    return MigrationStrategy(
      onCreate: (m) async {
      },
    );
  }
}

LazyDatabase _openConnection() {
  // the LazyDatabase util lets us find the right location for the file async.
  return LazyDatabase(() async {
    // put the database file, called db.sqlite here, into the documents folder
    // for your app.
    final dbFolder = await getApplicationDocumentsDirectory();
    final file = File(p.join(dbFolder.path, 'db.sqlite'));
    return NativeDatabase.createInBackground(file);
  });
}
```

### 4. Initialize Electric

The last step would be to `electrify` the database. This will configure the local SQLite database in order to automatically sync with the Electric service.

```dart
import 'package:electricsql/electricsql.dart';
import 'package:electricsql_flutter/drivers/drift.dart';
import 'package:myapp/generated/electric/migrations.dart';

// This would be the Drift database
AppDatabase db;

final electric = await electrify<AppDatabase>(
    dbName: '<db_name>',
    db: db,
    // Bundled migrations. This variable is autogenerated using 
    // `dart run electricsql_cli generate`
    migrations: kElectricMigrations,
    config: ElectricConfig(
        auth: AuthConfig(
            // https://electric-sql.com/docs/usage/auth
            // You can use the functions `insecureAuthToken` or `secureAuthToken` to generate one
            token: '<your JWT>',
        ),
        // logger: LoggerConfig(
        //     level: Level.debug, // in production you can use Logger.off
        // ),
        // url: '<ELECTRIC_SERVICE_URL>',
    ),
);
```

### 5. Define the Shapes to sync

Sync data into the local database. This only needs to be called once.

```dart
final shape = await electric.syncTables([
    'todos',
])
```

More info: https://electric-sql.com/docs/usage/data-access/shapes


### 6. Use the drift database normally

Everything should be working now. You can use the `drift` database normally.
Inserting, updating or deleting via the drift APIs should automatically sync the data in the Postgres database.

You can see some examples of writes and reads in the main [README](https://github.com/SkillDevs/electric_dart/blob/master/README.md).


### 7. (Optional) Configure how the Drift code for Electric is generated

Check out the following [instructions](https://github.com/SkillDevs/electric_dart/blob/master/docs/customize_drift_schema_generation.md)
